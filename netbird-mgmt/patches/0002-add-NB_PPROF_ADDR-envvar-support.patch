From 547c232a86ceda3bd01fc27550da3208127c7dc7 Mon Sep 17 00:00:00 2001
From: Ujaan Das <ujaandas03@gmail.com>
Date: Thu, 18 Dec 2025 17:21:13 +0000
Subject: [PATCH 2/2] add NB_PPROF_ADDR envvar support

---
 management/cmd/pprof.go | 33 +++++++++++++++++++++++++++++++++
 management/main.go      |  7 -------
 2 files changed, 33 insertions(+), 7 deletions(-)
 create mode 100644 management/cmd/pprof.go

diff --git a/management/cmd/pprof.go b/management/cmd/pprof.go
new file mode 100644
index 00000000..e85e9125
--- /dev/null
+++ b/management/cmd/pprof.go
@@ -0,0 +1,33 @@
+//go:build pprof
+// +build pprof
+
+package cmd
+
+import (
+	"net/http"
+	_ "net/http/pprof"
+	"os"
+
+	log "github.com/sirupsen/logrus"
+)
+
+func init() {
+	addr := pprofAddr()
+	go pprof(addr)
+}
+
+func pprofAddr() string {
+	listenAddr := os.Getenv("NB_PPROF_ADDR")
+	if listenAddr == "" {
+		return "localhost:6060"
+	}
+
+	return listenAddr
+}
+
+func pprof(listenAddr string) {
+	log.Infof("listening pprof on: %s\n", listenAddr)
+	if err := http.ListenAndServe(listenAddr, nil); err != nil {
+		log.Fatalf("Failed to start pprof: %v", err)
+	}
+}
diff --git a/management/main.go b/management/main.go
index ff8482f9..8db54370 100644
--- a/management/main.go
+++ b/management/main.go
@@ -1,19 +1,12 @@
 package main
 
 import (
-	"log"
-	"net/http"
-	// nolint:gosec
-	_ "net/http/pprof"
 	"os"
 
 	"github.com/netbirdio/netbird/management/cmd"
 )
 
 func main() {
-	go func() {
-		log.Println(http.ListenAndServe("localhost:6060", nil))
-	}()
 	if err := cmd.Execute(); err != nil {
 		os.Exit(1)
 	}
-- 
2.52.0

