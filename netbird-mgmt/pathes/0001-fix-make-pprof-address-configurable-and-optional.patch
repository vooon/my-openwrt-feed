From 1dfca66862597563591abb17d3b05174b0a04610 Mon Sep 17 00:00:00 2001
From: Vladimir Ermakov <vooon341@gmail.com>
Date: Wed, 24 Dec 2025 14:47:51 +0100
Subject: [PATCH] fix: make pprof address configurable and optional

---
 management/cmd/pprof.go | 33 +++++++++++++++++++++++++++++++++
 management/main.go      |  6 +-----
 signal/cmd/pprof.go     | 33 +++++++++++++++++++++++++++++++++
 signal/cmd/run.go       | 12 +-----------
 4 files changed, 68 insertions(+), 16 deletions(-)
 create mode 100644 management/cmd/pprof.go
 create mode 100644 signal/cmd/pprof.go

diff --git a/management/cmd/pprof.go b/management/cmd/pprof.go
new file mode 100644
index 00000000..e85e9125
--- /dev/null
+++ b/management/cmd/pprof.go
@@ -0,0 +1,33 @@
+//go:build pprof
+// +build pprof
+
+package cmd
+
+import (
+	"net/http"
+	_ "net/http/pprof"
+	"os"
+
+	log "github.com/sirupsen/logrus"
+)
+
+func init() {
+	addr := pprofAddr()
+	go pprof(addr)
+}
+
+func pprofAddr() string {
+	listenAddr := os.Getenv("NB_PPROF_ADDR")
+	if listenAddr == "" {
+		return "localhost:6060"
+	}
+
+	return listenAddr
+}
+
+func pprof(listenAddr string) {
+	log.Infof("listening pprof on: %s\n", listenAddr)
+	if err := http.ListenAndServe(listenAddr, nil); err != nil {
+		log.Fatalf("Failed to start pprof: %v", err)
+	}
+}
diff --git a/management/main.go b/management/main.go
index ff8482f9..27b995e7 100644
--- a/management/main.go
+++ b/management/main.go
@@ -1,8 +1,7 @@
 package main
 
 import (
-	"log"
-	"net/http"
+
 	// nolint:gosec
 	_ "net/http/pprof"
 	"os"
@@ -11,9 +10,6 @@ import (
 )
 
 func main() {
-	go func() {
-		log.Println(http.ListenAndServe("localhost:6060", nil))
-	}()
 	if err := cmd.Execute(); err != nil {
 		os.Exit(1)
 	}
diff --git a/signal/cmd/pprof.go b/signal/cmd/pprof.go
new file mode 100644
index 00000000..1e5950e7
--- /dev/null
+++ b/signal/cmd/pprof.go
@@ -0,0 +1,33 @@
+//go:build pprof
+// +build pprof
+
+package cmd
+
+import (
+	"net/http"
+	_ "net/http/pprof"
+	"os"
+
+	log "github.com/sirupsen/logrus"
+)
+
+func init() {
+	addr := pprofAddr()
+	go pprof(addr)
+}
+
+func pprofAddr() string {
+	listenAddr := os.Getenv("NB_PPROF_ADDR")
+	if listenAddr == "" {
+		return "localhost:6061"
+	}
+
+	return listenAddr
+}
+
+func pprof(listenAddr string) {
+	log.Infof("listening pprof on: %s\n", listenAddr)
+	if err := http.ListenAndServe(listenAddr, nil); err != nil {
+		log.Fatalf("Failed to start pprof: %v", err)
+	}
+}
diff --git a/signal/cmd/run.go b/signal/cmd/run.go
index bf8f8e32..e4751934 100644
--- a/signal/cmd/run.go
+++ b/signal/cmd/run.go
@@ -8,6 +8,7 @@ import (
 	"fmt"
 	"net"
 	"net/http"
+
 	// nolint:gosec
 	_ "net/http/pprof"
 	"time"
@@ -92,8 +93,6 @@ var (
 		RunE: func(cmd *cobra.Command, args []string) error {
 			flag.Parse()
 
-			startPprof()
-
 			opts, certManager, tlsConfig, err := getTLSConfigurations()
 			if err != nil {
 				return err
@@ -194,15 +193,6 @@ var (
 	}
 )
 
-func startPprof() {
-	go func() {
-		log.Debugf("Starting pprof server on 127.0.0.1:6060")
-		if err := http.ListenAndServe("127.0.0.1:6060", nil); err != nil {
-			log.Fatalf("pprof server failed: %v", err)
-		}
-	}()
-}
-
 func getTLSConfigurations() ([]grpc.ServerOption, *autocert.Manager, *tls.Config, error) {
 	var (
 		err         error
-- 
2.52.0

